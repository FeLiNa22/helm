{{- if and .Values.database.enabled .Values.database.backup.enabled }}
{{- $fullName := include "custom.fullname" . -}}
{{- $secretName := include "custom.postgresql.secretName" . -}}
{{- $secretKey := include "custom.postgresql.secretKey" . -}}

{{- $backupImage := "" }}
{{- if .Values.database.backup.image.repository }}
{{- $backupImage = printf "%s:%s" .Values.database.backup.image.repository (.Values.database.backup.image.tag | default "latest") }}
{{- else if eq .Values.database.mode "standalone" }}
{{- $backupImage = printf "%s:%s" .Values.database.standalone.image.repository .Values.database.standalone.image.tag }}
{{- else }}
{{- $backupImage = "postgres:16-alpine" }}
{{- end }}

{{- if and .Values.database.backup.persistence.enabled (not .Values.database.backup.persistence.existingClaim) }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ $fullName }}-db-backup
  labels:
    {{- include "custom.labels" . | nindent 4 }}
    app.kubernetes.io/component: database-backup
spec:
  accessModes:
    - {{ .Values.database.backup.persistence.accessMode }}
  {{- if .Values.database.backup.persistence.storageClass }}
  storageClassName: {{ .Values.database.backup.persistence.storageClass }}
  {{- end }}
  resources:
    requests:
      storage: {{ .Values.database.backup.persistence.size }}
{{- end }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $fullName }}-db-backup
  labels:
    {{- include "custom.labels" . | nindent 4 }}
    app.kubernetes.io/component: database-backup
spec:
  schedule: {{ .Values.database.backup.cron | quote }}
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "custom.selectorLabels" . | nindent 12 }}
            app.kubernetes.io/component: database-backup
        spec:
          {{- with .Values.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: {{ $backupImage }}
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - |
              set -e
              BACKUP_FILE="{{ .Values.database.backup.path }}/backup-$(date +%Y%m%d-%H%M%S).sql.gz"
              echo "Starting backup to $BACKUP_FILE"
              PGPASSWORD="$DB_PASSWORD" pg_dump -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_DATABASE" | gzip > "$BACKUP_FILE"
              echo "Backup completed: $BACKUP_FILE"
              
              # Cleanup old backups
              RETENTION={{ .Values.database.backup.retention }}
              if [ "$RETENTION" -gt 0 ]; then
                echo "Keeping last $RETENTION backups"
                cd {{ .Values.database.backup.path }}
                if ls backup-*.sql.gz >/dev/null 2>&1; then
                  ls -t backup-*.sql.gz | tail -n +$((RETENTION + 1)) | xargs -r rm -f
                  echo "Cleanup completed"
                else
                  echo "No existing backups to clean up"
                fi
              fi
              
              # List remaining backups
              echo "Current backups:"
              cd {{ .Values.database.backup.path }} && ls -lh backup-*.sql.gz 2>/dev/null || echo "No backups found"
            env:
            - name: DB_HOST
              value: {{ include "custom.postgresql.host" . }}
            - name: DB_PORT
              value: {{ include "custom.postgresql.port" . | quote }}
            - name: DB_DATABASE
              value: {{ include "custom.postgresql.database" . }}
            - name: DB_USER
              value: {{ include "custom.postgresql.username" . }}
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $secretName }}
                  key: {{ $secretKey }}
            volumeMounts:
            - name: backup
              mountPath: {{ .Values.database.backup.path }}
          volumes:
          - name: backup
            {{- if .Values.database.backup.persistence.enabled }}
            persistentVolumeClaim:
              claimName: {{ .Values.database.backup.persistence.existingClaim | default (printf "%s-db-backup" $fullName) }}
            {{- else }}
            emptyDir: {}
            {{- end }}
{{- end }}
