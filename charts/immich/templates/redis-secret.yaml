{{- if and .Values.redis.enabled .Values.redis.auth.enabled }}
{{- $secretName := .Values.redis.auth.existingSecret | default (printf "%s-redis" .Release.Name) }}
{{- if not .Values.redis.auth.existingSecret }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName }}
{{- $password := "" }}
{{- if $existingSecret }}
{{- $password = index $existingSecret.data "redis-password" | b64dec }}
{{- else }}
{{- $password = .Values.redis.auth.password | default (randAlphaNum 32) }}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "immich.labels" . | nindent 4 }}
    app.kubernetes.io/component: redis
type: Opaque
stringData:
  redis-password: {{ $password }}
{{- end }}
{{- end }}
