## @section Immich Server parameters

## @param replicaCount The number of replicas to deploy for the server.
## @param image.repository The Docker repository to pull the image from.
## @param image.pullPolicy The logic of image pulling.
## @param image.tag The image tag to use.
## @param image.autoupdate.enabled Enable automatic image updates via ArgoCD Image Updater.
## @param image.autoupdate.strategy Strategy for image updates (semver, latest, newest-build, name, alphabetical, digest).
## @param image.autoupdate.allowTags Match function for allowed tags (e.g., "regexp:^[0-9]+\\.[0-9]+\\.[0-9]+$" or "any").
## @param image.autoupdate.ignoreTags List of glob patterns to ignore specific tags.
## @param image.autoupdate.pullSecret Reference to secret for private registry authentication.
## @param image.autoupdate.platforms List of target platforms (e.g., ["linux/amd64", "linux/arm64"]).
## @param imagePullSecrets The image pull secrets to use.
## @param deployment.strategy.type The deployment strategy to use.
## @param serviceAccount.create Whether to create a service account.
## @param serviceAccount.annotations Additional annotations to add to the service account.
## @param serviceAccount.name The name of the service account to use.
## @param podAnnotations Additional annotations to add to the pod.
## @param podSecurityContext The security context to use for the pod.
## @param securityContext The security context to use for the container.
## @param initContainers Additional init containers to add to the pod.
## @param service.type The type of service to create.
## @param service.port The port on which the service will run.
## @param service.nodePort The nodePort to use for the service. Only used if service.type is NodePort.
## @param ingress.enabled Whether to create an ingress for the service.
## @param ingress.className The ingress class name to use.
## @param ingress.annotations Additional annotations to add to the ingress.
## @param ingress.hosts[0].host The host to use for the ingress.
## @param ingress.hosts[0].paths[0].path The path to use for the ingress.
## @param ingress.hosts[0].paths[0].pathType The path type to use for the ingress.
## @param ingress.tls The TLS configuration for the ingress.
## @param resources The resources to use for the pod.
## @param autoscaling.enabled Whether to enable autoscaling.
## @param autoscaling.minReplicas The minimum number of replicas to scale to.
## @param autoscaling.maxReplicas The maximum number of replicas to scale to.
## @param autoscaling.targetCPUUtilizationPercentage The target CPU utilization percentage to use for autoscaling.
## @param autoscaling.targetMemoryUtilizationPercentage The target memory utilization percentage to use for autoscaling.
## @param nodeSelector The node selector to use for the pod.
## @param tolerations The tolerations to use for the pod.
## @param affinity The affinity to use for the pod.
##
replicaCount: 1

image:
  repository: ghcr.io/immich-app/immich-server
  pullPolicy: IfNotPresent
  tag: "v2.4.1"
  autoupdate:
    enabled: false
    strategy: ""
    allowTags: ""
    ignoreTags: []
    pullSecret: ""
    platforms: []

imagePullSecrets: []

deployment:
  strategy:
    type: Recreate

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations: {}

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

initContainers: []
  # - name: init-container
  #   image: busybox
  #   command: ['sh', '-c', 'echo "this is an init container"']

service:
  type: ClusterIP
  port: 2283
  nodePort: ""

ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: immich.local
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: immich-tls
  #    hosts:
  #      - immich.local

resources: {}
  # limits:
  #   cpu: 2000m
  #   memory: 4Gi
  # requests:
  #   cpu: 500m
  #   memory: 1Gi

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

nodeSelector: {}

tolerations: []

affinity: {}

## Additional environment variables for the Immich server
## Use map format: key: value
env:
  TZ: "Europe/London"
  # IMMICH_LOG_LEVEL: "log"

## @section Machine Learning parameters

## @param machineLearning.enabled Whether to enable the machine learning component.
## @param machineLearning.replicaCount The number of replicas for machine learning.
## @param machineLearning.image.repository The Docker repository for machine learning image.
## @param machineLearning.image.pullPolicy The logic of image pulling.
## @param machineLearning.image.tag The image tag to use for machine learning.
## @param machineLearning.env.MACHINE_LEARNING_WORKERS Number of ML workers to run.
## @param machineLearning.env.MACHINE_LEARNING_WORKER_TIMEOUT ML worker timeout in seconds.
## @param machineLearning.resources The resources to use for machine learning pod.
## @param machineLearning.persistence.enabled Whether to enable persistence for ML cache.
## @param machineLearning.persistence.storageClass The storage class for ML cache.
## @param machineLearning.persistence.size The size of the ML cache volume.
## @param machineLearning.persistence.accessMode The access mode for the ML cache volume.
##
machineLearning:
  enabled: true
  replicaCount: 1
  image:
    repository: ghcr.io/immich-app/immich-machine-learning
    pullPolicy: IfNotPresent
    tag: "v2.4.1"
  env:
    MACHINE_LEARNING_WORKERS: "1"
    MACHINE_LEARNING_WORKER_TIMEOUT: "120"
  resources: {}
    # limits:
    #   cpu: 4000m
    #   memory: 8Gi
    # requests:
    #   cpu: 1000m
    #   memory: 2Gi
  persistence:
    enabled: true
    storageClass: ""
    size: 512Mi
    accessMode: ReadWriteOnce

## @section Persistence parameters

## @param persistence.library.enabled Whether to enable persistence for the library.
## @param persistence.library.storageClass The storage class to use for the library.
## @param persistence.library.existingClaim The name of an existing claim to use for the library.
## @param persistence.library.accessMode The access mode to use for the library.
## @param persistence.library.size The size to use for the library.
## @param persistence.additionalVolumes Additional volumes to add to the pod.
## @param persistence.additionalMounts Additional volume mounts to add to the pod.
##
persistence:
  library:
    enabled: true
    storageClass: ""
    existingClaim: ""
    accessMode: ReadWriteOnce
    size: 512Mi
  additionalVolumes: []
  additionalMounts: []

## @section Velero Backup Schedule parameters

## @param velero.enabled Whether to enable Velero backup schedules
## @param velero.namespace The namespace where Velero is deployed (Schedule CRD must be created in Velero namespace)
## @param velero.schedule The cron schedule for Velero backups (e.g., "0 2 * * *" for 2am daily)
## @param velero.ttl Time to live for backups (e.g., "720h" for 30 days)
## @param velero.includeClusterResources Whether to include cluster-scoped resources in backup
## @param velero.snapshotVolumes Whether to take volume snapshots
## @param velero.defaultVolumesToFsBackup Whether to use file system backup for volumes by default
## @param velero.storageLocation The storage location for backups (leave empty for default)
## @param velero.volumeSnapshotLocations The volume snapshot locations (leave empty for default)
## @param velero.labelSelector Additional label selector to filter resources (optional)
## @param velero.annotations Additional annotations to add to the Velero Schedule resources
velero:
  enabled: false
  namespace: "velero"
  schedule: "0 2 * * *"
  ttl: "168h"
  includeClusterResources: false
  snapshotVolumes: true
  defaultVolumesToFsBackup: false
  storageLocation: ""
  volumeSnapshotLocations: []
  labelSelector: {}
  annotations: {}

## @section DragonflyDB parameters
## DragonflyDB is a Redis-compatible in-memory data store used for Immich's job queue and caching

## @param dragonfly.mode The mode of DragonflyDB deployment: 'standalone', 'cluster', or 'external'.
## @param dragonfly.standalone.image.repository The Docker repository for Dragonfly image.
## @param dragonfly.standalone.image.tag The image tag for Dragonfly.
## @param dragonfly.standalone.resources Resource limits and requests for standalone Dragonfly.
## @param dragonfly.standalone.persistence.enabled Whether to enable persistence for standalone Dragonfly.
## @param dragonfly.standalone.persistence.size Size of the persistence volume for standalone Dragonfly.
## @param dragonfly.standalone.persistence.storageClass Storage class for standalone Dragonfly persistence.
## @param dragonfly.standalone.persistence.accessMode Access mode for standalone Dragonfly persistence volume.
## @param dragonfly.cluster.replicas Number of Dragonfly replicas in the cluster.
## @param dragonfly.cluster.image.repository The Docker repository for Dragonfly cluster image.
## @param dragonfly.cluster.image.tag The image tag for Dragonfly cluster.
## @param dragonfly.cluster.resources Resource limits and requests for Dragonfly cluster.
## @param dragonfly.cluster.persistence.enabled Whether to enable persistence for Dragonfly cluster.
## @param dragonfly.cluster.persistence.size Size of the persistence volume for Dragonfly cluster.
## @param dragonfly.cluster.persistence.storageClass Storage class for Dragonfly cluster persistence.
## @param dragonfly.cluster.persistence.accessMode Access mode for Dragonfly cluster persistence volume.
## @param dragonfly.cluster.snapshot.cron Cron schedule for Dragonfly cluster snapshots.
## @param dragonfly.external.host Hostname of external DragonflyDB/Redis (when mode is 'external').
## @param dragonfly.external.port Port of external DragonflyDB/Redis.
## @param dragonfly.external.existingSecret Secret name for external DragonflyDB/Redis password.
## @param dragonfly.external.passwordKey Key in the secret for the password.
##
dragonfly:
  # Mode options: 'standalone', 'cluster', or 'external'
  mode: standalone

  # Standalone Dragonfly deployment (simple single-instance)
  standalone:
    image:
      repository: docker.dragonflydb.io/dragonflydb/dragonfly
      tag: "v1.36.0"
    resources: {}
      # limits:
      #   cpu: 1000m
      #   memory: 2Gi
      # requests:
      #   cpu: 100m
      #   memory: 256Mi
    persistence:
      enabled: true
      size: 512Mi
      storageClass: ""
      accessMode: ReadWriteOnce

  # Dragonfly Cluster deployment (using DragonflyDB operator)
  cluster:
    replicas: 2
    image:
      repository: docker.dragonflydb.io/dragonflydb/dragonfly
      tag: "v1.36.0"
    resources: {}
      # limits:
      #   cpu: 2000m
      #   memory: 4Gi
      # requests:
      #   cpu: 500m
      #   memory: 512Mi
    persistence:
      enabled: true
      size: 512Mi
      storageClass: ""
      accessMode: ReadWriteOnce
    snapshot:
      # Snapshot schedule in cron format (default: every 5 minutes)
      cron: "*/5 * * * *"

  # External DragonflyDB/Redis configuration (used when mode is 'external')
  external:
    host: ""
    port: 6379
    existingSecret: ""
    passwordKey: "password"

## @section Database parameters
## PostgreSQL with vectorchord extension is required for Immich

## @param postgres.mode The mode of PostgreSQL deployment: 'standalone', 'cluster', or 'external'.
## @param postgres.initSQL Array of SQL commands to run on database initialization.
## @param postgres.username Username for the database.
## @param postgres.auth.password Password for the database user (leave empty to auto-generate).
## @param postgres.secret.name Existing secret name for database password (leave empty to auto-create).
## @param postgres.secret.passwordKey Key in the secret containing the password (default: password).
## @param postgres.standalone.persistence.enabled Enable persistence for standalone PostgreSQL.
## @param postgres.standalone.persistence.size Size of the persistence volume.
## @param postgres.standalone.persistence.storageClass Storage class for persistence.
## @param postgres.standalone.persistence.existingClaim Use an existing PVC.
## @param postgres.standalone.image.repository PostgreSQL image repository (with vectorchord extension).
## @param postgres.standalone.persistence.enabled Enable persistence for standalone PostgreSQL.
## @param postgres.standalone.persistence.size Size of the persistence volume.
## @param postgres.standalone.persistence.storageClass Storage class for persistence.
## @param postgres.standalone.persistence.existingClaim Use an existing PVC.
## @param postgres.standalone.image.tag PostgreSQL image tag.
## @param postgres.standalone.persistence.enabled Enable persistence for standalone PostgreSQL.
## @param postgres.standalone.persistence.size Size of the persistence volume.
## @param postgres.standalone.persistence.storageClass Storage class for persistence.
## @param postgres.standalone.persistence.existingClaim Use an existing PVC.
## @param postgres.standalone.image.autoupdate.enabled Enable automatic image updates for standalone database (default: false).
## @param postgres.standalone.persistence.enabled Enable persistence for standalone PostgreSQL.
## @param postgres.standalone.persistence.size Size of the persistence volume.
## @param postgres.standalone.persistence.storageClass Storage class for persistence.
## @param postgres.standalone.persistence.existingClaim Use an existing PVC.
## @param postgres.standalone.image.autoupdate.updateStrategy Strategy for image updates (e.g., semver, latest).
## @param postgres.standalone.resources Resource limits and requests for standalone PostgreSQL.
## @param postgres.cluster.name Name of the database cluster.
## @param postgres.cluster.instances Number of PostgreSQL instances (replicas).
## @param postgres.cluster.persistence.enabled Enable persistence for cluster PostgreSQL.
## @param postgres.cluster.persistence.size Size of the persistence volume.
## @param postgres.cluster.persistence.storageClass Storage class for persistence.
## @param postgres.cluster.image.repository PostgreSQL container image repository (with vectorchord extension).
## @param postgres.cluster.persistence.enabled Enable persistence for cluster PostgreSQL.
## @param postgres.cluster.persistence.size Size of the persistence volume.
## @param postgres.cluster.persistence.storageClass Storage class for persistence.
## @param postgres.cluster.image.tag PostgreSQL container image tag.
## @param postgres.cluster.persistence.enabled Enable persistence for cluster PostgreSQL.
## @param postgres.cluster.persistence.size Size of the persistence volume.
## @param postgres.cluster.persistence.storageClass Storage class for persistence.
## @param postgres.cluster.pitrBackup.enabled Enable PITR backups for CNPG cluster (default: false).
## @param postgres.cluster.persistence.enabled Enable persistence for cluster PostgreSQL.
## @param postgres.cluster.persistence.size Size of the persistence volume.
## @param postgres.cluster.persistence.storageClass Storage class for persistence.
## @param postgres.cluster.pitrBackup.retentionPolicy Retention policy for PITR backups (default: "30d").
## @param postgres.cluster.persistence.enabled Enable persistence for cluster PostgreSQL.
## @param postgres.cluster.persistence.size Size of the persistence volume.
## @param postgres.cluster.persistence.storageClass Storage class for persistence.
## @param postgres.cluster.pitrBackup.objectStorage.destinationPath S3 destination path (e.g., s3://bucket/path).
## @param postgres.cluster.persistence.enabled Enable persistence for cluster PostgreSQL.
## @param postgres.cluster.persistence.size Size of the persistence volume.
## @param postgres.cluster.persistence.storageClass Storage class for persistence.
## @param postgres.cluster.pitrBackup.objectStorage.endpointURL S3 endpoint URL for non-AWS storage.
## @param postgres.cluster.persistence.enabled Enable persistence for cluster PostgreSQL.
## @param postgres.cluster.persistence.size Size of the persistence volume.
## @param postgres.cluster.persistence.storageClass Storage class for persistence.
## @param postgres.cluster.pitrBackup.objectStorage.secretName Secret name containing ACCESS_KEY_ID and ACCESS_SECRET_KEY.
## @param postgres.cluster.persistence.enabled Enable persistence for cluster PostgreSQL.
## @param postgres.cluster.persistence.size Size of the persistence volume.
## @param postgres.cluster.persistence.storageClass Storage class for persistence.
## @param postgres.cluster.pitrBackup.objectStorage.region S3 region (optional).
## @param postgres.external.host Hostname of external PostgreSQL (when mode is 'external').
## @param postgres.external.port Port of external PostgreSQL.
## @param postgres.external.database Database name of external PostgreSQL.
## @param postgres.external.username Username of external PostgreSQL.
## @param postgres.backup.enabled Enable scheduled pg_dump backups for all database modes (default: false).
## @param postgres.backup.cron Cron schedule for backups (default: "0 2 * * *" for 2am daily).
## @param postgres.backup.retention Number of backups to retain (default: 30).
## @param postgres.backup.image.repository Custom image repository for backup job (optional).
## @param postgres.backup.image.tag Custom image tag for backup job (optional).
## @param postgres.backup.persistence.enabled Enable persistence for backups (default: true).
## @param postgres.backup.persistence.size Backup volume size (default: 512Mi).
## @param postgres.backup.persistence.storageClass Storage class for backup volume.
## @param postgres.backup.persistence.accessMode Access mode for backup volume (default: ReadWriteOnce).
## @param postgres.backup.persistence.existingClaim Use existing PVC for backups.
##
postgres:
  # Mode options: 'standalone', 'cluster', or 'external'
  mode: standalone
  # SQL commands to initialize extensions (vectorchord for Immich)
  # Each line should be a complete SQL statement
  initSQL:
    - "CREATE EXTENSION IF NOT EXISTS vchord CASCADE;"
    - "CREATE EXTENSION IF NOT EXISTS earthdistance CASCADE;"

  username: immich
  database: "immich"  # Database name (used in all modes)

  # Secret configuration for database password
  password:
    secretName: ""  # Leave empty to auto-generate (defaults to <release>-postgresql)
    secretKey: "password"  # Key in the secret containing the password

  # Standalone PostgreSQL deployment (using StatefulSet)
  standalone:
    # Use PostgreSQL with vectorchord extension for vector search
    image:
      repository: tensorchord/vchord-postgres
      tag: "pg16-v0.3.0"
      autoupdate:
        enabled: false
        updateStrategy: ""
    resources: {}
      # limits:
      #   cpu: 1000m
      #   memory: 2Gi
      # requests:
      #   cpu: 100m
      #   memory: 256Mi


    persistence:
      enabled: true
      size: 512Mi
      storageClass: ""
      existingClaim: ""
  # CloudNativePG Cluster deployment (using CNPG operator)
  cluster:
    persistence:
      enabled: true
      size: 512Mi
      storageClass: ""

    instances: 2
    # Use PostgreSQL image with vectorchord extension for Immich
    image:
      repository: tensorchord/cloudnative-vectorchord
      tag: "16-0.3.0"
    # PITR (Point-in-Time Recovery) backup configuration for CNPG
    # This is in addition to pg_dump backups configured in database.backup
    pitrBackup:
      enabled: false
      # Retention policy for PITR backups
      retentionPolicy: "30d"
      # Object storage configuration (S3-compatible)
      objectStorage:
        # S3 bucket destination path (e.g., s3://bucket-name/path/to/backups)
        destinationPath: ""
        # S3 endpoint URL (for non-AWS S3-compatible storage)
        endpointURL: ""
        # Name of the secret containing S3 credentials
        # Secret should contain ACCESS_KEY_ID and ACCESS_SECRET_KEY
        secretName: ""
        # S3 region (optional)
        region: ""

  # External PostgreSQL configuration (used when mode is 'external')
  external:
    host: ""
    port: 5432
    # Password is sourced from the secret configured in postgres.secret.name / postgres.secret.passwordKey

  # Scheduled database backups using pg_dump (works for all database modes)
  backup:
    enabled: false
    cron: "0 2 * * *"  # Daily at 2am
    retention: 30  # Number of backups to retain
    image:
      repository: ""  # Leave empty to use standalone image or postgres:16-alpine for external mode
      tag: ""
    persistence:
      enabled: true
      size: 512Mi
      storageClass: ""
      accessMode: ReadWriteOnce
      existingClaim: ""


## @section ArgoCD Image Updater parameters

## @param imageUpdater.namespace Namespace where the ImageUpdater CRD will be created.
## @param imageUpdater.argocdNamespace Namespace where ArgoCD Applications are located.
## @param imageUpdater.applicationName Name or pattern of the ArgoCD Application to update. Defaults to Release name.
## @param imageUpdater.imageAlias Alias for the image in the ImageUpdater CRD. Defaults to Release name.
## @param imageUpdater.forceUpdate Force update even if image is not currently deployed.
## @param imageUpdater.helm Helm-specific configuration for parameter names (e.g., {name: "image.repository", tag: "image.tag"}).
## @param imageUpdater.kustomize Kustomize-specific configuration (e.g., {name: "original/image"}).
## @param imageUpdater.writeBackConfig Write-back configuration for GitOps.
##
imageUpdater:
  namespace: argocd
  argocdNamespace: argocd
  applicationName: ""
  imageAlias: ""
  forceUpdate: false
  helm: {}
  kustomize: {}
  writeBackConfig: {}
