## @section Immich Server parameters

## @param replicaCount The number of replicas to deploy for the server.
## @param image.repository The Docker repository to pull the image from.
## @param image.pullPolicy The logic of image pulling.
## @param image.tag The image tag to use.
## @param imagePullSecrets The image pull secrets to use.
## @param deployment.strategy.type The deployment strategy to use.
## @param serviceAccount.create Whether to create a service account.
## @param serviceAccount.annotations Additional annotations to add to the service account.
## @param serviceAccount.name The name of the service account to use.
## @param podAnnotations Additional annotations to add to the pod.
## @param podSecurityContext The security context to use for the pod.
## @param securityContext The security context to use for the container.
## @param initContainers Additional init containers to add to the pod.
## @param service.type The type of service to create.
## @param service.port The port on which the service will run.
## @param service.nodePort The nodePort to use for the service. Only used if service.type is NodePort.
## @param ingress.enabled Whether to create an ingress for the service.
## @param ingress.className The ingress class name to use.
## @param ingress.annotations Additional annotations to add to the ingress.
## @param ingress.hosts[0].host The host to use for the ingress.
## @param ingress.hosts[0].paths[0].path The path to use for the ingress.
## @param ingress.hosts[0].paths[0].pathType The path type to use for the ingress.
## @param ingress.tls The TLS configuration for the ingress.
## @param resources The resources to use for the pod.
## @param autoscaling.enabled Whether to enable autoscaling.
## @param autoscaling.minReplicas The minimum number of replicas to scale to.
## @param autoscaling.maxReplicas The maximum number of replicas to scale to.
## @param autoscaling.targetCPUUtilizationPercentage The target CPU utilization percentage to use for autoscaling.
## @param autoscaling.targetMemoryUtilizationPercentage The target memory utilization percentage to use for autoscaling.
## @param nodeSelector The node selector to use for the pod.
## @param tolerations The tolerations to use for the pod.
## @param affinity The affinity to use for the pod.
## @param env.TZ The timezone to use for the pod.
##
replicaCount: 1

image:
  repository: ghcr.io/immich-app/immich-server
  pullPolicy: IfNotPresent
  tag: "v2.4.1"

imagePullSecrets: []

deployment:
  strategy:
    type: Recreate

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations: {}

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

initContainers: []
  # - name: init-container
  #   image: busybox
  #   command: ['sh', '-c', 'echo "this is an init container"']

service:
  type: ClusterIP
  port: 2283
  nodePort: ""

ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: immich.local
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: immich-tls
  #    hosts:
  #      - immich.local

resources: {}
  # limits:
  #   cpu: 2000m
  #   memory: 4Gi
  # requests:
  #   cpu: 500m
  #   memory: 1Gi

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

nodeSelector: {}

tolerations: []

affinity: {}

## Additional environment variables for the Immich server
## Use map format: key: value
env:
  TZ: "Europe/London"
  # IMMICH_LOG_LEVEL: "log"

## @section Machine Learning parameters

## @param machineLearning.enabled Whether to enable the machine learning component.
## @param machineLearning.replicaCount The number of replicas for machine learning.
## @param machineLearning.image.repository The Docker repository for machine learning image.
## @param machineLearning.image.pullPolicy The logic of image pulling.
## @param machineLearning.image.tag The image tag to use for machine learning.
## @param machineLearning.env.MACHINE_LEARNING_WORKERS Number of ML workers to run.
## @param machineLearning.env.MACHINE_LEARNING_WORKER_TIMEOUT ML worker timeout in seconds.
## @param machineLearning.resources The resources to use for machine learning pod.
## @param machineLearning.persistence.enabled Whether to enable persistence for ML cache.
## @param machineLearning.persistence.storageClass The storage class for ML cache.
## @param machineLearning.persistence.size The size of the ML cache volume.
## @param machineLearning.persistence.accessMode The access mode for the ML cache volume.
##
machineLearning:
  enabled: true
  replicaCount: 1
  image:
    repository: ghcr.io/immich-app/immich-machine-learning
    pullPolicy: IfNotPresent
    tag: "v2.4.1"
  env:
    MACHINE_LEARNING_WORKERS: "1"
    MACHINE_LEARNING_WORKER_TIMEOUT: "120"
  resources: {}
    # limits:
    #   cpu: 4000m
    #   memory: 8Gi
    # requests:
    #   cpu: 1000m
    #   memory: 2Gi
  persistence:
    enabled: true
    storageClass: ""
    size: 10Gi
    accessMode: ReadWriteOnce

## @section Persistence parameters

## @param persistence.library.enabled Whether to enable persistence for the library.
## @param persistence.library.storageClass The storage class to use for the library.
## @param persistence.library.existingClaim The name of an existing claim to use for the library.
## @param persistence.library.accessMode The access mode to use for the library.
## @param persistence.library.size The size to use for the library.
## @param persistence.additionalVolumes Additional volumes to add to the pod.
## @param persistence.additionalMounts Additional volume mounts to add to the pod.
##
persistence:
  library:
    enabled: true
    storageClass: ""
    existingClaim: ""
    accessMode: ReadWriteOnce
    size: 100Gi
  additionalVolumes: []
  additionalMounts: []

## @section Valkey parameters
## Valkey (Redis-compatible) is required for Immich's job queue and caching

## @param valkey.enabled Whether to deploy Valkey for high availability.
## @param valkey.replicas Number of Valkey replicas for high availability.
## @param valkey.image.repository Valkey container image repository.
## @param valkey.image.tag Valkey container image tag.
## @param valkey.image.pullPolicy Valkey image pull policy.
## @param valkey.auth.enabled Enable or disable authentication for Valkey.
## @param valkey.auth.password Valkey password (leave empty to auto-generate).
## @param valkey.auth.existingSecret Secret name for existing Valkey password.
## @param valkey.maxmemory Maximum memory for Valkey.
## @param valkey.maxmemoryPolicy Memory eviction policy for Valkey.
## @param valkey.persistence.enabled Enable persistence for Valkey.
## @param valkey.persistence.size Size of the Valkey persistence volume.
## @param valkey.persistence.storageClass Storage class name for Valkey persistent volumes.
## @param valkey.resources Resource limits and requests for Valkey.
##
valkey:
  enabled: true
  replicas: 3
  image:
    repository: valkey/valkey
    tag: "8.0"
    pullPolicy: IfNotPresent
  auth:
    enabled: false
    password: ""
    existingSecret: ""
  maxmemory: "256mb"
  maxmemoryPolicy: "allkeys-lru"
  persistence:
    enabled: true
    size: 1Gi
    storageClass: ""
  resources: {}
    # limits:
    #   cpu: 500m
    #   memory: 512Mi
    # requests:
    #   cpu: 100m
    #   memory: 256Mi

## @section Redis parameters (DEPRECATED - use Valkey instead)
## Redis is required for Immich's job queue and caching

## @param redis.enabled Whether to deploy the Redis subchart (DEPRECATED - use valkey.enabled instead).
## @param redis.architecture Redis deployment architecture: 'standalone' or 'replication'.
## @param redis.auth.enabled Enable or disable authentication for Redis.
## @param redis.external.host Hostname of external Redis (when redis.enabled=false and valkey.enabled=false).
## @param redis.external.port Port of external Redis.
## @param redis.external.existingSecret Secret name for external Redis password.
##
redis:
  enabled: false
  architecture: standalone
  auth:
    enabled: false
  # External Redis configuration (used when both redis.enabled=false and valkey.enabled=false)
  external:
    host: ""
    port: 6379
    existingSecret: ""

## @section Database parameters
## CloudNative-PG PostgreSQL cluster with pgvector extension is required for Immich

## @param database.enabled Whether to deploy CloudNative-PG PostgreSQL cluster.
## @param database.instances Number of PostgreSQL instances (replicas) for high availability.
## @param database.image.repository PostgreSQL container image repository.
## @param database.image.tag PostgreSQL container image tag.
## @param database.database Name of the database to create.
## @param database.owner Owner of the database.
## @param database.storage.size Size of the storage for each PostgreSQL instance.
## @param database.storage.storageClass Storage class name for PostgreSQL persistent volumes.
## @param database.secret.name Name of the secret containing database credentials.
## @param database.secret.create Whether to create the database secret.
## @param database.secret.username Database user username.
## @param database.secret.password Database user password (leave empty to auto-generate).
## @param database.superuserSecret.name Name of the secret containing the superuser credentials.
## @param database.superuserSecret.create Whether to create the superuser secret.
## @param database.superuserSecret.username Superuser username.
## @param database.superuserSecret.password Superuser password (leave empty to auto-generate).
## @param database.monitoring.enablePodMonitor Enable Prometheus PodMonitor for monitoring.
##
database:
  enabled: true
  instances: 3
  image:
    repository: ghcr.io/cloudnative-pg/postgresql
    tag: "16.6"
  database: immich
  owner: immich
  storage:
    size: 10Gi
    storageClass: ""
  secret:
    name: ""
    create: true
    username: immich
    password: ""
  superuserSecret:
    name: ""
    create: true
    username: postgres
    password: ""
  monitoring:
    enablePodMonitor: false

## @section PostgreSQL parameters (DEPRECATED - use database instead)
## PostgreSQL with pgvector/vectorchord extension is required for Immich

## @param postgresql.enabled Whether to deploy the PostgreSQL subchart (DEPRECATED - use database.enabled instead).
## @param postgresql.architecture PostgreSQL deployment architecture: 'standalone' or 'replication'.
## @param postgresql.auth.database Name of the default database.
## @param postgresql.auth.username Username for the default database.
## @param postgresql.auth.password Password for the default database user.
## @param postgresql.auth.postgresPassword Password for the 'postgres' administrative user.
## @param postgresql.auth.existingSecret Reference to an existing Kubernetes secret containing the database credentials.
## @param postgresql.image.registry PostgreSQL image registry.
## @param postgresql.image.repository PostgreSQL image repository.
## @param postgresql.image.tag PostgreSQL image tag.
## @param postgresql.primary.initdb.scripts.init-extensions.sql SQL script to initialize PostgreSQL extensions.
## @param postgresql.primary.persistence.enabled Whether to enable persistence for PostgreSQL.
## @param postgresql.primary.persistence.size Size of the PostgreSQL persistence volume.
## @param postgresql.external.host Hostname of external PostgreSQL (when postgresql.enabled=false and database.enabled=false).
## @param postgresql.external.port Port of external PostgreSQL.
## @param postgresql.external.database Database name of external PostgreSQL.
## @param postgresql.external.username Username of external PostgreSQL.
## @param postgresql.external.existingSecret Secret name for external PostgreSQL password.
## @param postgresql.external.secretKey Key in the secret for the password.
##
postgresql:
  enabled: false
  architecture: standalone
  auth:
    database: immich
    username: immich
    password: ""
    postgresPassword: ""
    existingSecret: ""
  # Use PostgreSQL with pgvecto-rs extension
  image:
    registry: docker.io
    repository: tensorchord/pgvecto-rs
    tag: "pg16-v0.4.0"
  primary:
    initdb:
      scripts:
        init-extensions.sql: |
          CREATE EXTENSION IF NOT EXISTS vectors;
          CREATE EXTENSION IF NOT EXISTS earthdistance CASCADE;
          CREATE EXTENSION IF NOT EXISTS pg_trgm;
    persistence:
      enabled: true
      size: 10Gi
  # External PostgreSQL configuration (used when both postgresql.enabled=false and database.enabled=false)
  external:
    host: ""
    port: 5432
    database: "immich"
    username: "immich"
    existingSecret: ""
    secretKey: "password"
