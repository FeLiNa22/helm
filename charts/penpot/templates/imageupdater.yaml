{{- if or .Values.backend.image.autoupdate.enabled .Values.frontend.image.autoupdate.enabled .Values.exporter.image.autoupdate.enabled }}
apiVersion: argocd-image-updater.argoproj.io/v1alpha1
kind: ImageUpdater
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Values.imageUpdater.namespace | default "argocd" }}
  labels:
    app: {{ .Release.Name }}
    release: {{ .Release.Name }}
spec:
  namespace: {{ .Values.imageUpdater.argocdNamespace | default "argocd" }}
  applicationRefs:
    - namePattern: {{ .Values.imageUpdater.applicationName | default .Release.Name | quote }}
      images:
        {{- if .Values.backend.image.autoupdate.enabled }}
        - alias: "backend"
          imageName: {{ .Values.backend.image.repository }}{{ if .Values.backend.image.tag }}:{{ .Values.backend.image.tag }}{{ end }}
          {{- if or .Values.backend.image.autoupdate.strategy .Values.backend.image.autoupdate.allowTags .Values.backend.image.autoupdate.ignoreTags .Values.backend.image.autoupdate.pullSecret .Values.backend.image.autoupdate.platforms }}
          commonUpdateSettings:
            {{- if .Values.backend.image.autoupdate.strategy }}
            updateStrategy: {{ .Values.backend.image.autoupdate.strategy }}
            {{- end }}
            {{- if .Values.backend.image.autoupdate.allowTags }}
            allowTags: {{ .Values.backend.image.autoupdate.allowTags | quote }}
            {{- end }}
            {{- if .Values.backend.image.autoupdate.ignoreTags }}
            ignoreTags:
              {{- if kindIs "string" .Values.backend.image.autoupdate.ignoreTags }}
              - {{ .Values.backend.image.autoupdate.ignoreTags | quote }}
              {{- else }}
              {{- toYaml .Values.backend.image.autoupdate.ignoreTags | nindent 14 }}
              {{- end }}
            {{- end }}
            {{- if .Values.backend.image.autoupdate.pullSecret }}
            pullSecret: {{ .Values.backend.image.autoupdate.pullSecret | quote }}
            {{- end }}
            {{- if .Values.backend.image.autoupdate.platforms }}
            platforms:
              {{- toYaml .Values.backend.image.autoupdate.platforms | nindent 14 }}
            {{- end }}
          {{- end }}
        {{- end }}
        {{- if .Values.frontend.image.autoupdate.enabled }}
        - alias: "frontend"
          imageName: {{ .Values.frontend.image.repository }}{{ if .Values.frontend.image.tag }}:{{ .Values.frontend.image.tag }}{{ end }}
          {{- if or .Values.frontend.image.autoupdate.strategy .Values.frontend.image.autoupdate.allowTags .Values.frontend.image.autoupdate.ignoreTags .Values.frontend.image.autoupdate.pullSecret .Values.frontend.image.autoupdate.platforms }}
          commonUpdateSettings:
            {{- if .Values.frontend.image.autoupdate.strategy }}
            updateStrategy: {{ .Values.frontend.image.autoupdate.strategy }}
            {{- end }}
            {{- if .Values.frontend.image.autoupdate.allowTags }}
            allowTags: {{ .Values.frontend.image.autoupdate.allowTags | quote }}
            {{- end }}
            {{- if .Values.frontend.image.autoupdate.ignoreTags }}
            ignoreTags:
              {{- if kindIs "string" .Values.frontend.image.autoupdate.ignoreTags }}
              - {{ .Values.frontend.image.autoupdate.ignoreTags | quote }}
              {{- else }}
              {{- toYaml .Values.frontend.image.autoupdate.ignoreTags | nindent 14 }}
              {{- end }}
            {{- end }}
            {{- if .Values.frontend.image.autoupdate.pullSecret }}
            pullSecret: {{ .Values.frontend.image.autoupdate.pullSecret | quote }}
            {{- end }}
            {{- if .Values.frontend.image.autoupdate.platforms }}
            platforms:
              {{- toYaml .Values.frontend.image.autoupdate.platforms | nindent 14 }}
            {{- end }}
          {{- end }}
        {{- end }}
        {{- if .Values.exporter.image.autoupdate.enabled }}
        - alias: "exporter"
          imageName: {{ .Values.exporter.image.repository }}{{ if .Values.exporter.image.tag }}:{{ .Values.exporter.image.tag }}{{ end }}
          {{- if or .Values.exporter.image.autoupdate.strategy .Values.exporter.image.autoupdate.allowTags .Values.exporter.image.autoupdate.ignoreTags .Values.exporter.image.autoupdate.pullSecret .Values.exporter.image.autoupdate.platforms }}
          commonUpdateSettings:
            {{- if .Values.exporter.image.autoupdate.strategy }}
            updateStrategy: {{ .Values.exporter.image.autoupdate.strategy }}
            {{- end }}
            {{- if .Values.exporter.image.autoupdate.allowTags }}
            allowTags: {{ .Values.exporter.image.autoupdate.allowTags | quote }}
            {{- end }}
            {{- if .Values.exporter.image.autoupdate.ignoreTags }}
            ignoreTags:
              {{- if kindIs "string" .Values.exporter.image.autoupdate.ignoreTags }}
              - {{ .Values.exporter.image.autoupdate.ignoreTags | quote }}
              {{- else }}
              {{- toYaml .Values.exporter.image.autoupdate.ignoreTags | nindent 14 }}
              {{- end }}
            {{- end }}
            {{- if .Values.exporter.image.autoupdate.pullSecret }}
            pullSecret: {{ .Values.exporter.image.autoupdate.pullSecret | quote }}
            {{- end }}
            {{- if .Values.exporter.image.autoupdate.platforms }}
            platforms:
              {{- toYaml .Values.exporter.image.autoupdate.platforms | nindent 14 }}
            {{- end }}
          {{- end }}
        {{- end }}
{{- end }}
