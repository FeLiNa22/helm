{{- $anyAutoupdate := false }}
{{- $services := list "jellyfin" "emby" "plex" "sonarr" "radarr" "lidarr" "prowlarr" "bazarr" "qbittorrent" "sabnzbd" "seerr" "huntarr" "cleanuparr" "flaresolverr" "acestream" }}
{{- range $service := $services }}
  {{- $serviceConfig := index $.Values $service }}
  {{- if and $serviceConfig.enabled $serviceConfig.image.autoupdate.enabled }}
    {{- $anyAutoupdate = true }}
  {{- end }}
{{- end }}
{{- if and .Values.qbittorrent.enabled .Values.qbittorrent.gluetun.enabled .Values.qbittorrent.gluetun.image.autoupdate.enabled }}
  {{- $anyAutoupdate = true }}
{{- end }}
{{- if and .Values.acestream.enabled .Values.acestream.gluetun.enabled .Values.acestream.gluetun.image.autoupdate.enabled }}
  {{- $anyAutoupdate = true }}
{{- end }}
{{- if $anyAutoupdate }}
apiVersion: argocd-image-updater.argoproj.io/v1alpha1
kind: ImageUpdater
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Values.imageUpdater.namespace | default "argocd" }}
  labels:
    app: {{ .Release.Name }}
    release: {{ .Release.Name }}
spec:
  namespace: {{ .Values.imageUpdater.argocdNamespace | default "argocd" }}
  applicationRefs:
    - namePattern: {{ .Values.imageUpdater.applicationName | default .Release.Name | quote }}
      images:
        {{- range $service := $services }}
          {{- $serviceConfig := index $.Values $service }}
          {{- if and $serviceConfig.enabled $serviceConfig.image.autoupdate.enabled }}
            {{- $imageTag := $serviceConfig.image.tag | toString }}
            {{- $imageTag = regexReplaceAll "@[a-z0-9]+:[a-f0-9]+" $imageTag "" }}
            {{- $updateStrategy := $serviceConfig.image.autoupdate.strategy }}
            {{- $imageName := $serviceConfig.image.repository }}
            {{- if not $updateStrategy }}
              {{- if or (eq $imageTag "latest") (hasSuffix "-latest" $imageTag) }}
                {{- $updateStrategy = "digest" }}
                {{- $imageName = printf "%s:%s" $serviceConfig.image.repository $imageTag }}
              {{- else if regexMatch "^[0-9]+\\.[0-9]+\\.[0-9]+$" $imageTag }}
                {{- $updateStrategy = "semver" }}
                {{- $parts := regexSplit "\\." $imageTag -1 }}
                {{- $major := index $parts 0 }}
                {{- $minor := index $parts 1 }}
                {{- $imageName = printf "%s:%s.%s.x" $serviceConfig.image.repository $major $minor }}
              {{- end }}
            {{- else if and (eq $updateStrategy "semver") $serviceConfig.image.tag }}
              {{- if regexMatch "^[0-9]+\\.[0-9]+\\.[0-9]+$" $imageTag }}
                {{- $parts := regexSplit "\\." $imageTag -1 }}
                {{- $major := index $parts 0 }}
                {{- $minor := index $parts 1 }}
                {{- $imageName = printf "%s:%s.%s.x" $serviceConfig.image.repository $major $minor }}
              {{- else }}
                {{- $imageName = printf "%s:%s" $serviceConfig.image.repository $imageTag }}
              {{- end }}
            {{- else if $serviceConfig.image.tag }}
              {{- $imageName = printf "%s:%s" $serviceConfig.image.repository $imageTag }}
            {{- end }}
        - alias: {{ $service | quote }}
          imageName: {{ $imageName }}
          {{- if or $updateStrategy $serviceConfig.image.autoupdate.allowTags $serviceConfig.image.autoupdate.ignoreTags $serviceConfig.image.autoupdate.pullSecret $serviceConfig.image.autoupdate.platforms }}
          commonUpdateSettings:
            {{- if $updateStrategy }}
            updateStrategy: {{ $updateStrategy }}
            {{- end }}
            {{- if $serviceConfig.image.autoupdate.allowTags }}
            allowTags: {{ $serviceConfig.image.autoupdate.allowTags | quote }}
            {{- end }}
            {{- if $serviceConfig.image.autoupdate.ignoreTags }}
            ignoreTags:
              {{- if kindIs "string" $serviceConfig.image.autoupdate.ignoreTags }}
              - {{ $serviceConfig.image.autoupdate.ignoreTags | quote }}
              {{- else }}
              {{- toYaml $serviceConfig.image.autoupdate.ignoreTags | nindent 14 }}
              {{- end }}
            {{- end }}
            {{- if $serviceConfig.image.autoupdate.pullSecret }}
            pullSecret: {{ $serviceConfig.image.autoupdate.pullSecret | quote }}
            {{- end }}
            {{- if $serviceConfig.image.autoupdate.platforms }}
            platforms:
              {{- toYaml $serviceConfig.image.autoupdate.platforms | nindent 14 }}
            {{- end }}
          {{- end }}
          manifestTargets:
            helm:
              name: {{ printf "%s.image.repository" $service | quote }}
              tag: {{ printf "%s.image.tag" $service | quote }}
          {{- end }}
        {{- end }}
        {{- if and .Values.qbittorrent.enabled .Values.qbittorrent.gluetun.enabled .Values.qbittorrent.gluetun.image.autoupdate.enabled }}
        {{- $imageTag := .Values.qbittorrent.gluetun.image.tag | toString }}
        {{- $imageTag = regexReplaceAll "@[a-z0-9]+:[a-f0-9]+" $imageTag "" }}
        {{- $updateStrategy := .Values.qbittorrent.gluetun.image.autoupdate.strategy }}
        {{- $imageName := .Values.qbittorrent.gluetun.image.repository }}
        {{- if not $updateStrategy }}
          {{- if or (eq $imageTag "latest") (hasSuffix "-latest" $imageTag) }}
            {{- $updateStrategy = "digest" }}
            {{- $imageName = printf "%s:%s" .Values.qbittorrent.gluetun.image.repository $imageTag }}
          {{- else if regexMatch "^v?[0-9]+\\.[0-9]+\\.[0-9]+$" $imageTag }}
            {{- $updateStrategy = "semver" }}
            {{- $cleanTag := regexReplaceAll "^v" $imageTag "" }}
            {{- $parts := regexSplit "\\." $cleanTag -1 }}
            {{- $major := index $parts 0 }}
            {{- $minor := index $parts 1 }}
            {{- if hasPrefix "v" $imageTag }}
              {{- $imageName = printf "%s:v%s.%s.x" .Values.qbittorrent.gluetun.image.repository $major $minor }}
            {{- else }}
              {{- $imageName = printf "%s:%s.%s.x" .Values.qbittorrent.gluetun.image.repository $major $minor }}
            {{- end }}
          {{- end }}
        {{- else if and (eq $updateStrategy "semver") .Values.qbittorrent.gluetun.image.tag }}
          {{- if regexMatch "^v?[0-9]+\\.[0-9]+\\.[0-9]+$" $imageTag }}
            {{- $cleanTag := regexReplaceAll "^v" $imageTag "" }}
            {{- $parts := regexSplit "\\." $cleanTag -1 }}
            {{- $major := index $parts 0 }}
            {{- $minor := index $parts 1 }}
            {{- if hasPrefix "v" $imageTag }}
              {{- $imageName = printf "%s:v%s.%s.x" .Values.qbittorrent.gluetun.image.repository $major $minor }}
            {{- else }}
              {{- $imageName = printf "%s:%s.%s.x" .Values.qbittorrent.gluetun.image.repository $major $minor }}
            {{- end }}
          {{- else }}
            {{- $imageName = printf "%s:%s" .Values.qbittorrent.gluetun.image.repository $imageTag }}
          {{- end }}
        {{- else if .Values.qbittorrent.gluetun.image.tag }}
          {{- $imageName = printf "%s:%s" .Values.qbittorrent.gluetun.image.repository $imageTag }}
        {{- end }}
        - alias: "qbittorrent-gluetun"
          imageName: {{ $imageName }}
          {{- if or $updateStrategy .Values.qbittorrent.gluetun.image.autoupdate.allowTags .Values.qbittorrent.gluetun.image.autoupdate.ignoreTags .Values.qbittorrent.gluetun.image.autoupdate.pullSecret .Values.qbittorrent.gluetun.image.autoupdate.platforms }}
          commonUpdateSettings:
            {{- if $updateStrategy }}
            updateStrategy: {{ $updateStrategy }}
            {{- end }}
            {{- if .Values.qbittorrent.gluetun.image.autoupdate.allowTags }}
            allowTags: {{ .Values.qbittorrent.gluetun.image.autoupdate.allowTags | quote }}
            {{- end }}
            {{- if .Values.qbittorrent.gluetun.image.autoupdate.ignoreTags }}
            ignoreTags:
              {{- if kindIs "string" .Values.qbittorrent.gluetun.image.autoupdate.ignoreTags }}
              - {{ .Values.qbittorrent.gluetun.image.autoupdate.ignoreTags | quote }}
              {{- else }}
              {{- toYaml .Values.qbittorrent.gluetun.image.autoupdate.ignoreTags | nindent 14 }}
              {{- end }}
            {{- end }}
            {{- if .Values.qbittorrent.gluetun.image.autoupdate.pullSecret }}
            pullSecret: {{ .Values.qbittorrent.gluetun.image.autoupdate.pullSecret | quote }}
            {{- end }}
            {{- if .Values.qbittorrent.gluetun.image.autoupdate.platforms }}
            platforms:
              {{- toYaml .Values.qbittorrent.gluetun.image.autoupdate.platforms | nindent 14 }}
            {{- end }}
          {{- end }}
          manifestTargets:
            helm:
              name: "qbittorrent.gluetun.image.repository"
              tag: "qbittorrent.gluetun.image.tag"
        {{- end }}
        {{- if and .Values.acestream.enabled .Values.acestream.gluetun.enabled .Values.acestream.gluetun.image.autoupdate.enabled }}
        {{- $imageTag := .Values.acestream.gluetun.image.tag | toString }}
        {{- $imageTag = regexReplaceAll "@[a-z0-9]+:[a-f0-9]+" $imageTag "" }}
        {{- $updateStrategy := .Values.acestream.gluetun.image.autoupdate.strategy }}
        {{- $imageName := .Values.acestream.gluetun.image.repository }}
        {{- if not $updateStrategy }}
          {{- if or (eq $imageTag "latest") (hasSuffix "-latest" $imageTag) }}
            {{- $updateStrategy = "digest" }}
            {{- $imageName = printf "%s:%s" .Values.acestream.gluetun.image.repository $imageTag }}
          {{- else if regexMatch "^v?[0-9]+\\.[0-9]+\\.[0-9]+$" $imageTag }}
            {{- $updateStrategy = "semver" }}
            {{- $cleanTag := regexReplaceAll "^v" $imageTag "" }}
            {{- $parts := regexSplit "\\." $cleanTag -1 }}
            {{- $major := index $parts 0 }}
            {{- $minor := index $parts 1 }}
            {{- if hasPrefix "v" $imageTag }}
              {{- $imageName = printf "%s:v%s.%s.x" .Values.acestream.gluetun.image.repository $major $minor }}
            {{- else }}
              {{- $imageName = printf "%s:%s.%s.x" .Values.acestream.gluetun.image.repository $major $minor }}
            {{- end }}
          {{- end }}
        {{- else if and (eq $updateStrategy "semver") .Values.acestream.gluetun.image.tag }}
          {{- if regexMatch "^v?[0-9]+\\.[0-9]+\\.[0-9]+$" $imageTag }}
            {{- $cleanTag := regexReplaceAll "^v" $imageTag "" }}
            {{- $parts := regexSplit "\\." $cleanTag -1 }}
            {{- $major := index $parts 0 }}
            {{- $minor := index $parts 1 }}
            {{- if hasPrefix "v" $imageTag }}
              {{- $imageName = printf "%s:v%s.%s.x" .Values.acestream.gluetun.image.repository $major $minor }}
            {{- else }}
              {{- $imageName = printf "%s:%s.%s.x" .Values.acestream.gluetun.image.repository $major $minor }}
            {{- end }}
          {{- else }}
            {{- $imageName = printf "%s:%s" .Values.acestream.gluetun.image.repository $imageTag }}
          {{- end }}
        {{- else if .Values.acestream.gluetun.image.tag }}
          {{- $imageName = printf "%s:%s" .Values.acestream.gluetun.image.repository $imageTag }}
        {{- end }}
        - alias: "acestream-gluetun"
          imageName: {{ $imageName }}
          {{- if or $updateStrategy .Values.acestream.gluetun.image.autoupdate.allowTags .Values.acestream.gluetun.image.autoupdate.ignoreTags .Values.acestream.gluetun.image.autoupdate.pullSecret .Values.acestream.gluetun.image.autoupdate.platforms }}
          commonUpdateSettings:
            {{- if $updateStrategy }}
            updateStrategy: {{ $updateStrategy }}
            {{- end }}
            {{- if .Values.acestream.gluetun.image.autoupdate.allowTags }}
            allowTags: {{ .Values.acestream.gluetun.image.autoupdate.allowTags | quote }}
            {{- end }}
            {{- if .Values.acestream.gluetun.image.autoupdate.ignoreTags }}
            ignoreTags:
              {{- if kindIs "string" .Values.acestream.gluetun.image.autoupdate.ignoreTags }}
              - {{ .Values.acestream.gluetun.image.autoupdate.ignoreTags | quote }}
              {{- else }}
              {{- toYaml .Values.acestream.gluetun.image.autoupdate.ignoreTags | nindent 14 }}
              {{- end }}
            {{- end }}
            {{- if .Values.acestream.gluetun.image.autoupdate.pullSecret }}
            pullSecret: {{ .Values.acestream.gluetun.image.autoupdate.pullSecret | quote }}
            {{- end }}
            {{- if .Values.acestream.gluetun.image.autoupdate.platforms }}
            platforms:
              {{- toYaml .Values.acestream.gluetun.image.autoupdate.platforms | nindent 14 }}
            {{- end }}
          {{- end }}
          manifestTargets:
            helm:
              name: "acestream.gluetun.image.repository"
              tag: "acestream.gluetun.image.tag"
        {{- end }}
  {{- if .Values.imageUpdater.writeBackConfig }}
  writeBackConfig:
    {{- toYaml .Values.imageUpdater.writeBackConfig | nindent 4 }}
  {{- end }}
{{- end }}

