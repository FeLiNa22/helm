{{- if and .Values.qbittorrent.enabled .Values.qbittorrent.gluetun.enabled .Values.qbittorrent.gluetun.portForwarding.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-qbittorrent-port-forwarding
  labels:
    app.kubernetes.io/name: qbittorrent
    app.kubernetes.io/instance: {{ .Release.Name }}-qbittorrent
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
    app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
    app.kubernetes.io/part-of: {{ .Release.Name | quote }}
data:
  on_port_forward.sh: |
    #!/bin/sh
    set -e
    
    # This script is called by gluetun when a port is forwarded
    # The forwarded port is passed as the first argument
    FORWARDED_PORT=$1
    
    echo "Port forwarded: $FORWARDED_PORT"
    
    # Wait for qBittorrent to be ready
    echo "Waiting for qBittorrent to start..."
    until wget -q --spider http://localhost:{{ .Values.qbittorrent.service.web.port }}/api/v2/app/webapiVersion 2>/dev/null; do
      sleep 5
    done
    
    echo "qBittorrent is ready, updating port configuration..."
    
    # Get current preferences
    COOKIE=$(mktemp)
    
    # Login to qBittorrent (default credentials on first run)
    # Try with default admin:adminpass, then with empty password
    if ! wget --save-cookies "$COOKIE" --keep-session-cookies \
         --post-data 'username=admin&password=adminpass' \
         -qO- http://localhost:{{ .Values.qbittorrent.service.web.port }}/api/v2/auth/login 2>/dev/null; then
      wget --save-cookies "$COOKIE" --keep-session-cookies \
           --post-data 'username=admin&password=' \
           -qO- http://localhost:{{ .Values.qbittorrent.service.web.port }}/api/v2/auth/login 2>/dev/null || true
    fi
    
    # Update the listening port
    wget --load-cookies "$COOKIE" --keep-session-cookies \
         --post-data "json={\"listen_port\":$FORWARDED_PORT,\"random_port\":false,\"upnp\":false}" \
         -qO- http://localhost:{{ .Values.qbittorrent.service.web.port }}/api/v2/app/setPreferences
    
    rm -f "$COOKIE"
    
    echo "qBittorrent port updated to $FORWARDED_PORT"
    
    # Store the port for monitoring
    echo "$FORWARDED_PORT" > /tmp/gluetun_forwarded_port
  
  monitor_port.sh: |
    #!/bin/sh
    # This script monitors the forwarded port and restarts the pod when it changes
    # It runs continuously in the background
    
    LAST_PORT=""
    CHECK_INTERVAL={{ .Values.qbittorrent.gluetun.portForwarding.monitorInterval | default 300 }}
    
    echo "Starting port monitoring with check interval: ${CHECK_INTERVAL}s"
    
    while true; do
      sleep "$CHECK_INTERVAL"
      
      if [ -f /tmp/gluetun_forwarded_port ]; then
        CURRENT_PORT=$(cat /tmp/gluetun_forwarded_port 2>/dev/null || echo "")
        
        if [ -n "$CURRENT_PORT" ] && [ -n "$LAST_PORT" ] && [ "$CURRENT_PORT" != "$LAST_PORT" ]; then
          echo "Port changed from $LAST_PORT to $CURRENT_PORT"
          echo "Port expiration detected - container will restart via liveness probe failure"
          # Exit to trigger a restart via liveness probe
          exit 1
        fi
        
        LAST_PORT="$CURRENT_PORT"
      fi
    done
{{- end }}
