{{- if and .Values.qbittorrent.enabled .Values.qbittorrent.gluetun.enabled .Values.qbittorrent.gluetun.portForwarding.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-qbittorrent-port-forwarding
  labels:
    app.kubernetes.io/name: qbittorrent
    app.kubernetes.io/instance: {{ .Release.Name }}-qbittorrent
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
    app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
    app.kubernetes.io/part-of: {{ .Release.Name | quote }}
data:
  on_port_forward.sh: |
    #!/bin/sh
    set -e
    
    # This script is called by gluetun when a port is forwarded
    # The forwarded port is passed as the first argument
    FORWARDED_PORT=$1
    
    echo "Port forwarded: $FORWARDED_PORT"
    
    # Store the forwarded port
    # The linuxserver/qbittorrent:latest image supports TORRENTING_PORT environment variable
    # The port will be applied on next container start
    echo "$FORWARDED_PORT" > /tmp/gluetun_forwarded_port
    
    echo "Forwarded port $FORWARDED_PORT stored. Container will use TORRENTING_PORT=$FORWARDED_PORT on next restart."
  
  monitor_port.sh: |
    #!/bin/sh
    # This script monitors the forwarded port and restarts the pod when it changes
    # It runs continuously in the background
    
    LAST_PORT=""
    CHECK_INTERVAL={{ .Values.qbittorrent.gluetun.portForwarding.monitorInterval | default 300 }}
    
    echo "Starting port monitoring with check interval: ${CHECK_INTERVAL}s"
    
    while true; do
      sleep "$CHECK_INTERVAL"
      
      if [ -f /tmp/gluetun_forwarded_port ]; then
        CURRENT_PORT=$(cat /tmp/gluetun_forwarded_port 2>/dev/null || echo "")
        
        if [ -n "$CURRENT_PORT" ] && [ -n "$LAST_PORT" ] && [ "$CURRENT_PORT" != "$LAST_PORT" ]; then
          echo "Port changed from $LAST_PORT to $CURRENT_PORT"
          echo "Port expiration detected - container will restart via liveness probe failure"
          # Exit to trigger a restart via liveness probe
          exit 1
        fi
        
        LAST_PORT="$CURRENT_PORT"
      fi
    done
{{- end }}
