{{- if and .Values.prowlarr.enabled (or (eq .Values.prowlarr.database.mode "external") (eq .Values.prowlarr.database.mode "cluster")) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-prowlarr-config
  labels:
    app.kubernetes.io/name: prowlarr
    app.kubernetes.io/instance: {{ .Release.Name }}-prowlarr
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
    app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
    app.kubernetes.io/part-of: {{ .Release.Name | quote }}
data:
  db-config.xml: |
    {{- if eq .Values.prowlarr.database.mode "cluster" }}
    <PostgresUser>{{ .Values.prowlarr.database.auth.username | default "prowlarr" }}</PostgresUser>
    <PostgresPassword>__DB_PASSWORD__</PostgresPassword>
    <PostgresHost>{{ .Values.prowlarr.database.cluster.name | default (printf "%s-prowlarr-db" .Release.Name) }}-rw</PostgresHost>
    <PostgresPort>{{ .Values.prowlarr.database.external.port }}</PostgresPort>
    {{- else }}
    <PostgresUser>{{ required "prowlarr.database.auth.username is required when prowlarr.database.mode is 'external'" .Values.prowlarr.database.auth.username }}</PostgresUser>
    <PostgresPassword>__DB_PASSWORD__</PostgresPassword>
    <PostgresHost>{{ required "prowlarr.database.external.host is required when prowlarr.database.mode is 'external'" .Values.prowlarr.database.external.host }}</PostgresHost>
    <PostgresPort>{{ .Values.prowlarr.database.external.port }}</PostgresPort>
    {{- end }}
    <PostgresMainDb>{{ .Values.prowlarr.database.external.mainDatabase }}</PostgresMainDb>
    <PostgresLogDb>{{ .Values.prowlarr.database.external.logDatabase }}</PostgresLogDb>
{{- end }}
